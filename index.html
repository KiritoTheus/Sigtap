<!DOCTYPE html>
<html lang="pt-BR" data-theme="dark">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ACQUA SIGTAP">
    <link rel="apple-touch-icon" href="icon.png">

    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIGTAP Pro - Instituto Acqua</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --cyan: #22d3ee;
            --text: #f8fafc; --text-dim: #94a3b8; --border: rgba(255,255,255,0.1);
            --opme: #10b981; --proc: #f59e0b; --danger: #ef4444;
        }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; color: var(--text); padding-bottom: 40px; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 20px; background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 1000; }
        .logo { font-weight: 800; font-size: 1.1rem; }
        .logo span { color: var(--accent); }
        .search-container { padding: 15px; max-width: 800px; margin: 0 auto; position: relative; }
        .search-box { width: 100%; padding: 14px 18px; border-radius: 12px; border: 2px solid var(--border); background: var(--card); color: var(--text); font-size: 1rem; outline: none; box-sizing: border-box; }
        #results { position: absolute; width: calc(100% - 30px); top: 75px; background: var(--card); border-radius: 12px; border: 1px solid var(--border); max-height: 350px; overflow-y: auto; z-index: 2000; display: none; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
        .item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; }
        .container { max-width: 1000px; margin: 0 auto; padding: 10px; display: none; }
        .hero-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid var(--border); margin-bottom: 15px; border-top: 4px solid var(--accent); }
        
        /* AJUSTE PARA CABER 5 ITENS NA GRADE */
        .grid-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        @media (min-width: 600px) { .grid-stats { grid-template-columns: repeat(5, 1fr); } }
        
        .stat-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-box small { display: block; font-size: 0.6rem; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; }
        .stat-box b { color: var(--cyan); font-size: 0.95rem; }
        .price-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        @media (min-width: 600px) { .price-row { grid-template-columns: repeat(4, 1fr); } }
        .price-tag { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 10px; text-align: center; border: 1px solid var(--border); }
        .price-tag.total { background: var(--accent); border: none; }
        .nav-tabs { display: flex; gap: 8px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; position: sticky; top: 60px; background: var(--bg); z-index: 900; }
        .tab-btn { padding: 10px 18px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; color: var(--text-dim); cursor: pointer; white-space: nowrap; font-weight: 700; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }
        .tab-btn.active { background: var(--accent); color: white; }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .card-list { background: var(--card); border: 1px solid var(--border); border-radius: 15px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; color: #fff; text-transform: uppercase; }
        .badge-opme { background: var(--opme); }
        .badge-proc { background: var(--proc); }
        .badge-excl { background: var(--danger); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        #btn-back {
            position: fixed !important;
            bottom: 30px;
            right: 20px;
            z-index: 9999 !important;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<header>
    <div class="logo">ACQUA<span>SIGTAP</span></div>
    <button onclick="document.getElementById('file').click()" style="background:var(--accent); color:#fff; border:none; padding:8px 15px; border-radius:10px; font-weight:700; cursor:pointer;">SUBIR ZIP</button>
    <input type="file" id="file" style="display:none">
</header>

<div id="st" style="text-align:center; font-size:0.65rem; padding:8px; color:var(--cyan); font-weight:bold;">MODO AUDITORIA ATIVO</div>

<div class="search-container">
    <input type="text" id="sin" class="search-box" placeholder="Ex: 0408050500..." disabled>
    <div id="results"></div>
</div>

<main class="container" id="ui">
    <div class="hero-card">
        <h1 id="ui-n" style="margin:0 0 15px 0; font-size:1.3rem;"></h1>
        
        <div class="grid-stats">
            <div class="stat-box" style="border-color: var(--cyan); background: rgba(34, 211, 238, 0.05);">
                <small>Código</small>
                <b id="st-cod" style="font-family: monospace; font-size: 1rem; letter-spacing: 1px;"></b>
            </div>
            <div class="stat-box"><small>Qtd Max</small><b id="st-q"></b></div>
            <div class="stat-box"><small>Permanência</small><b id="st-p"></b></div>
            <div class="stat-box"><small>Idade</small><b id="st-i"></b></div>
            <div class="stat-box"><small>Gênero</small><b id="st-s"></b></div>
        </div>

        <div class="price-row">
            <div class="price-tag"><small>SA</small><br><b id="v-sa"></b></div>
            <div class="price-tag"><small>SH</small><br><b id="v-sh"></b></div>
            <div class="price-tag"><small>SP</small><br><b id="v-sp"></b></div>
            <div class="price-tag total"><small>TOTAL</small><br><b id="v-tt"></b></div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" onclick="tab(event, 'tab-mat')"><i class="fa-solid fa-layer-group"></i> Compatíveis/Excludentes</button>
        <button class="tab-btn" onclick="tab(event, 'tab-det')"><i class="fa-solid fa-tags"></i> Atributos</button>
        <button class="tab-btn" onclick="tab(event, 'tab-cid')"><i class="fa-solid fa-stethoscope"></i> CIDs</button>
        <button class="tab-btn" onclick="tab(event, 'tab-cbo')"><i class="fa-solid fa-user-md"></i> CBOs Permitidos</button>
        <button class="tab-btn" onclick="tab(event, 'tab-desc')"><i class="fa-solid fa-align-left"></i> Descrição</button>
        <button class="tab-btn" onclick="tab(event, 'tab-leito')"><i class="fa-solid fa-bed"></i> Leitos</button>
        <button class="tab-btn" onclick="tab(event, 'tab-serv')"><i class="fa-solid fa-hospital-user"></i> Serviços/Classif.</button>
        <button class="tab-btn" onclick="tab(event, 'tab-hab')"><i class="fa-solid fa-certificate"></i> Habilitações</button>
    </div>

    <div id="tab-mat" class="tab-content" style="display:block;"></div>
    <div id="tab-det" class="tab-content"></div>
    <div id="tab-cid" class="tab-content"></div>
    <div id="tab-desc" class="tab-content"><div id="ui-desc" style="padding:15px; color:var(--text-dim);"></div></div>
    <div id="tab-cbo" class="tab-content"></div>
    <div id="tab-leito" class="tab-content"></div>
    <div id="tab-serv" class="tab-content"></div>
    <div id="tab-hab" class="tab-content"></div>
</main>

<button id="btn-back" onclick="window.location.href='../index.php'">
    <i class="fa-solid fa-house"></i>
</button>

<script>

// Função para remover acentos e deixar em minúsculo
const normalizar = (str) => 
    str.normalize("NFD")
       .replace(/[\u0300-\u036f]/g, "")
       .toLowerCase();

const NOMES_LEITOS = {
    "01": "CIRURGICO", "02": "OBSTETRICO", "03": "PEDIATRICO", 
    "04": "TISSIOLOGIA", "05": "PSIQUIATRIA", "06": "CRONICOS", 
    "07": "CLINICO", "08": "HOSPITAL DIA"
};

let db;
let DATA = { 
    pList: [], pMap: {}, desc: {}, dets: {}, cids: {}, cbos: {}, 
    relCbo: {}, relLeito: {}, servicos: {}, classificacoes: {}, relServ: {}, 
    registros: {}, relReg: {}, relDet: {}, relCid: {}, relMat: {}, 
    habilitacoes: {}, relHab: {} 
};

const dec = new TextDecoder('iso-8859-1');

const req = indexedDB.open("ACQUA_FINAL_V2", 1);
req.onupgradeneeded = e => {
    const d = e.target.result;
    if (!d.objectStoreNames.contains("data")) d.createObjectStore("data");
};
req.onsuccess = e => {
    db = e.target.result;
    db.transaction("data").objectStore("data").get("current").onsuccess = ev => {
        if(ev.target.result) { 
            DATA = ev.target.result; 
            unlock(); 
        }
    };
};

function unlock() { 
    document.getElementById('sin').disabled = false; 
    document.getElementById('st').innerText = "BASE CARREGADA"; 
}

document.getElementById('file').onchange = async (e) => {
    const file = e.target.files[0]; if(!file) return;
    document.getElementById('st').innerText = "PROCESSANDO...";
    DATA = { 
        pList: [], pMap: {}, desc: {}, dets: {}, cids: {}, cbos: {}, 
        relCbo: {}, relLeito: {}, servicos: {}, classificacoes: {}, relServ: {}, 
        registros: {}, relReg: {}, relDet: {}, relCid: {}, relMat: {}, 
        habilitacoes: {}, relHab: {} 
    };
    const zip = await JSZip.loadAsync(file);
    const parse = async (name, cb) => {
        const f = zip.file(name); if(!f) return;
        const text = dec.decode(await f.async("arraybuffer"));
        text.split('\n').forEach(cb);
    };

    await parse("tb_procedimento.txt", l => {
        if(l.length >= 318) {
            const i = {
                c: l.substring(0, 10).trim(), n: l.substring(10, 260).trim(), sex: l.substring(261, 262).trim(),
                qmx: l.substring(262, 266).trim(), prm: l.substring(266, 270).trim(),
                iMi: l.substring(274, 278).trim(), iMa: l.substring(278, 282).trim(),
                sh: l.substring(282, 294).trim(), sa: l.substring(294, 306).trim(), sp: l.substring(306, 318).trim()
            };
            DATA.pList.push(i); DATA.pMap[i.c] = i;
        }
    });

    await parse("tb_descricao.txt", l => DATA.desc[l.substring(0,10).trim()] = l.substring(10).trim());
    await parse("tb_detalhe.txt", l => DATA.dets[l.substring(0,3).trim()] = l.substring(3,103).trim());
    await parse("tb_cid.txt", l => DATA.cids[l.substring(0,4).trim()] = l.substring(4,104).trim());
    await parse("rl_procedimento_detalhe.txt", l => {
        const p = l.substring(0,10).trim(), d = l.substring(10,13).trim();
        if(!DATA.relDet[p]) DATA.relDet[p] = []; DATA.relDet[p].push(d);
    });
    await parse("rl_procedimento_cid.txt", l => {
        const p = l.substring(0,10).trim(), c = l.substring(10,14).trim();
        if(!DATA.relCid[p]) DATA.relCid[p] = []; DATA.relCid[p].push(c);
    });
    await parse("rl_procedimento_compativel.txt", l => {
        if(l.length >= 29) {
            const p1 = l.substring(0, 10).trim(), p2 = l.substring(12, 22).trim(), tipo = l.substring(24, 25).trim(), qtd = l.substring(26, 29).trim(); 
            if(p1 && p2) {
                if(!DATA.relMat[p1]) DATA.relMat[p1] = []; DATA.relMat[p1].push({c: p2, t: tipo, q: qtd});
                if(!DATA.relMat[p2]) DATA.relMat[p2] = []; DATA.relMat[p2].push({c: p1, t: tipo, q: qtd});
            }
        }
    });
    await parse("tb_ocupacao.txt", l => {
        const cod = l.substring(0, 6).trim();
        if(cod) DATA.cbos[cod] = l.substring(6, 156).trim();
    });
    await parse("rl_procedimento_ocupacao.txt", l => {
        const p = l.substring(0, 10).trim(), c = l.substring(10, 16).trim();
        if(p && c && !DATA.relCbo[p]?.includes(c)) { if(!DATA.relCbo[p]) DATA.relCbo[p] = []; DATA.relCbo[p].push(c); }
    });
    await parse("rl_procedimento_leito.txt", l => {
        const p = l.substring(0, 10).trim(), leito = l.substring(10, 12).trim();
        if(p && leito && !DATA.relLeito[p]?.includes(leito)) { if(!DATA.relLeito[p]) DATA.relLeito[p] = []; DATA.relLeito[p].push(leito); }
    });
    await parse("tb_servico.txt", l => {
        const cod = l.substring(0, 3).trim();
        if(cod) DATA.servicos[cod] = l.substring(3, 123).trim();
    });
    await parse("tb_servico_classificacao.txt", l => {
        const s = l.substring(0, 3).trim(), c = l.substring(3, 6).trim();
        if(s && c) DATA.classificacoes[s + c] = l.substring(6, 156).trim();
    });
    await parse("rl_procedimento_servico.txt", l => {
        const p = l.substring(0, 10).trim(), s = l.substring(10, 13).trim(), c = l.substring(13, 16).trim();
        if(p && s && !DATA.relServ[p]?.find(x => x.s === s && x.c === c)) { if(!DATA.relServ[p]) DATA.relServ[p] = []; DATA.relServ[p].push({s, c}); }
    });
    await parse("tb_habilitacao.txt", l => {
        const cod = l.substring(0, 4).trim();
        if(cod) DATA.habilitacoes[cod] = l.substring(4, 154).trim();
    });
    await parse("rl_procedimento_habilitacao.txt", l => {
        const p = l.substring(0, 10).trim(), h = l.substring(10, 14).trim();
        if(p && h && !DATA.relHab[p]?.includes(h)) { if(!DATA.relHab[p]) DATA.relHab[p] = []; DATA.relHab[p].push(h); }
    });
    await parse("tb_registro.txt", l => {
        const cod = l.substring(0, 2).trim();
        if(cod) DATA.registros[cod] = l.substring(2, 52).trim();
    });
    await parse("rl_procedimento_registro.txt", l => {
        const p = l.substring(0, 10).trim(), r = l.substring(10, 12).trim();
        if(p && r && !DATA.relReg[p]?.includes(r)) { if(!DATA.relReg[p]) DATA.relReg[p] = []; DATA.relReg[p].push(r); }
    });
    if(db) {
        const tx = db.transaction("data", "readwrite");
        tx.objectStore("data").put(DATA, "current");
        tx.oncomplete = () => { unlock(); alert("Competência atualizada!"); };
    }
};

document.getElementById('sin').oninput = function() {
    const q = normalizar(this.value);
    const res = document.getElementById('results');
    
    if(q.length < 3) { 
        res.style.display = 'none'; 
        return; 
    }

    // --- BUSCA PROCEDIMENTOS ---
    const procs = DATA.pList.filter(p => 
        normalizar(p.c).includes(q) || normalizar(p.n).includes(q)
    ).slice(0, 10);

    // --- BUSCA CIDs ---
    const cidsEncontrados = Object.keys(DATA.cids)
        .filter(key => normalizar(key).includes(q) || normalizar(DATA.cids[key]).includes(q))
        .slice(0, 5);

    // Gerar HTML de Procedimentos
    let html = procs.map(m => `
        <div class="item" onclick="show('${m.c}')">
            <span class="badge badge-proc">PROC</span> <b>${m.c}</b><br>
            <small>${m.n}</small>
        </div>
    `).join('');

    // Gerar HTML de CIDs (com função especial de clique)
    html += cidsEncontrados.map(c => `
        <div class="item" onclick="buscarProcedimentosPorCID('${c}')" style="border-left: 5px solid var(--cyan)">
            <span class="badge" style="background:var(--cyan)">CID</span> <b>${c}</b><br>
            <small>${DATA.cids[c]}</small>
        </div>
    `).join('');

    res.innerHTML = html || "<div class='item'>Nenhum resultado</div>";
    res.style.display = 'block';
};

function show(cod) {
    const p = DATA.pMap[cod];
    if (!p) return;

    document.getElementById('results').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    document.getElementById('btn-back').style.display = 'flex';

    // AJUSTE: Preenchimento do NOVO BLOCO de Código
    document.getElementById('st-cod').innerText = p.c;
    document.getElementById('ui-n').innerText = p.n;
    
    document.getElementById('st-q').innerText = p.qmx == "9999" ? "Ilimit." : p.qmx;
    document.getElementById('st-p').innerText = p.prm + " dias";
    document.getElementById('st-i').innerText = `${Math.floor(p.iMi/12)}-${Math.floor(p.iMa/12)}a`;
    document.getElementById('st-s').innerText = p.sex == 'M' ? 'Masc' : p.sex == 'F' ? 'Fem' : 'Ambos';

    document.getElementById('v-sa').innerText = fmt(p.sa);
    document.getElementById('v-sh').innerText = fmt(p.sh);
    document.getElementById('v-sp').innerText = fmt(p.sp);
    document.getElementById('v-tt').innerText = fmt(parseInt(p.sh) + parseInt(p.sp) + parseInt(p.sa));

    let regHtml = '<div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:12px;">';
    if (DATA.relReg[cod]) {
        DATA.relReg[cod].forEach(r => {
            const nome = DATA.registros[r] || 'Reg. ' + r;
            regHtml += `<span style="background:#10b981; color:white; padding:4px 10px; border-radius:8px; font-size:0.7rem; font-weight:bold; display:inline-flex; align-items:center; gap:4px;"><i class="fa-solid fa-file-invoice"></i> ${nome}</span>`;
        });
    }
    regHtml += '</div>';
    document.getElementById('ui-desc').innerHTML = `<div style="margin-bottom:8px; line-height:1.4;">${DATA.desc[cod] || "Sem descrição."}</div>${regHtml}`;

    const fill = (id, list, fn) => {
        const box = document.getElementById(id);
        if(box) box.innerHTML = (list && list.length) ? list.map(fn).join('') : "<p style='padding:20px; opacity:0.5'>Sem dados.</p>";
    };

    // Aba Compatíveis com Quantidades Zeradas
    const b = document.getElementById('tab-mat');
    let list = DATA.relMat ? DATA.relMat[cod] || [] : [];
    const uniqueMap = new Map();
    list.forEach(item => {
        const isExcl = (item.t === "3" || item.t === "4" || item.c === "0415020034");
        if (!uniqueMap.has(item.c) || isExcl) uniqueMap.set(item.c, item);
    });

    b.innerHTML = Array.from(uniqueMap.values()).map(m => {
        const info = DATA.pMap[m.c];
        const isExcl = (m.t === "3" || m.t === "4" || m.c === "0415020034"); 
        const isOPME = m.c.startsWith('07');
        let color = isExcl ? 'var(--danger)' : (isOPME ? 'var(--opme)' : 'var(--proc)');
        let label = isExcl ? 'EXCLUDENTE' : (isOPME ? 'OPME' : 'COMPATÍVEL');
        let badgeClass = isExcl ? 'badge-excl' : (isOPME ? 'badge-opme' : 'badge-proc');
        
        // EXIBE QUANTIDADES ZERADAS CONFORME SOLICITADO
        const quantidade = m.q !== undefined ? parseInt(m.q) : '--';

        return `<div class="card-list" style="border-left: 5px solid ${color}">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <span class="badge ${badgeClass}">${label}</span>
                    <span style="font-size: 0.75rem; font-weight: 800; margin-left: 10px; color: var(--text-dim);">QTD: ${quantidade}</span>
                </div>
                <b style="color:var(--cyan); font-family:monospace;">${m.c}</b>
            </div>
            <div style="font-weight:600; font-size:0.85rem; margin:8px 0;">${info ? info.n : 'Procedimento não mapeado'}</div>
            <div style="text-align:right; font-size:0.8rem; font-weight:bold; color:${color}">
                ${isExcl ? 'BLOQUEIA PRINCIPAL' : (info ? 'SH: ' + fmt(info.sh) : '--')}
            </div>
        </div>`;
    }).join('') || "<p style='padding:20px; opacity:0.5'>Nenhuma relação encontrada.</p>";

    fill('tab-det', DATA.relDet[cod], d => `<div class="card-list"><b>${d}</b> - ${DATA.dets[d] || 'Detalhe'}</div>`);
    fill('tab-cid', DATA.relCid[cod], c => `<div class="card-list"><b>${c}</b> - ${DATA.cids[c] || 'CID'}</div>`);
    fill('tab-cbo', DATA.relCbo[cod], c => `<div class="card-list" style="border-left:5px solid var(--accent)"><b>${c}</b> - ${DATA.cbos[c] || 'CBO'}</div>`);
    fill('tab-leito', DATA.relLeito[cod], l => `<div class="card-list"><b>${NOMES_LEITOS[l] || 'Leito '+l}</b></div>`);
    fill('tab-serv', DATA.relServ[cod], x => `<div class="card-list"><b>${x.s} - ${DATA.servicos[x.s] || 'Serviço'}</b><br><small>${x.c} - ${DATA.classificacoes[x.s+x.c] || 'Classificação'}</small></div>`);
    fill('tab-hab', DATA.relHab[cod], h => `<div class="card-list"><b>${h}</b> - ${DATA.habilitacoes[h] || 'Habilitação'}</div>`);

    window.scrollTo({top: 0, behavior: 'smooth'});
}

function fmt(v) { return (parseInt(v)/100 || 0).toLocaleString('pt-BR', {style:'currency', currency:'BRL'}); }
function tab(e, id) {
    document.querySelectorAll('.tab-content').forEach(x => x.style.display = 'none');
    document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
    document.getElementById(id).style.display = 'block';
    e.currentTarget.classList.add('active');
}

function buscarProcedimentosPorCID(codCID) {
    const res = document.getElementById('results');
    const input = document.getElementById('sin');
    
    // Filtra todos os procedimentos que possuem esse CID na relação
    const listaProcs = DATA.pList.filter(p => {
        const relacao = DATA.relCid[p.c] || [];
        return relacao.includes(codCID);
    });

    input.value = `Procedimentos para CID ${codCID}`;
    
    res.innerHTML = `
        <div style="padding:10px; background:var(--bg); font-size:0.7rem; color:var(--cyan); font-weight:bold; border-bottom:1px solid var(--border)">
            ${codCID} - ${DATA.cids[codCID]}
        </div>
    ` + listaProcs.map(m => `
        <div class="item" onclick="show('${m.c}')">
            <b>${m.c}</b><br>
            <small>${m.n}</small>
        </div>
    `).join('');
    
    res.style.display = 'block';
}

</script>
</body>
</html>